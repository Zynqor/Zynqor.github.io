<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/6.0.5/fancybox/fancybox.css" integrity="sha256-uTcjoMD6rPt4OyV3Rs02Slxl0BJGMNVKAm/1eYPt2go=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhangkuang.asia","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="前言 本文目标:本指南记录了在Xilinx Zynq-7020平台上实现AXI DMA回环测试的完整开发过程，包括从硬件设计确认到最终C++应用程序实现的全部步骤。硬件平台文件依赖Zynq-7000-完整硬件平台构建与验证权威指南">
<meta property="og:type" content="article">
<meta property="og:title" content="Xilinx Zynq AXI DMA回环开发完整指南">
<meta property="og:url" content="http://zhangkuang.asia/2025/08/05/Xilinx-Zynq-AXI-DMA%E5%9B%9E%E7%8E%AF%E5%BC%80%E5%8F%91%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="Kuang&#39;s Tech Log">
<meta property="og:description" content="前言 本文目标:本指南记录了在Xilinx Zynq-7020平台上实现AXI DMA回环测试的完整开发过程，包括从硬件设计确认到最终C++应用程序实现的全部步骤。硬件平台文件依赖Zynq-7000-完整硬件平台构建与验证权威指南">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-08-05T14:44:50.000Z">
<meta property="article:modified_time" content="2025-08-18T08:28:13.212Z">
<meta property="article:author" content="Zzkuang">
<meta property="article:tag" content="Zynq">
<meta property="article:tag" content="Petalinux">
<meta property="article:tag" content="Xilinx">
<meta property="article:tag" content="AXI-DMA">
<meta property="article:tag" content="UIO">
<meta property="article:tag" content="CMA">
<meta property="article:tag" content="嵌入式Linux">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="FPGA">
<meta property="article:tag" content="硬件软件协同">
<meta property="article:tag" content="视频处理">
<meta property="article:tag" content="高性能计算">
<meta property="article:tag" content="开发指南">
<meta property="article:tag" content="最佳实践">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://zhangkuang.asia/2025/08/05/Xilinx-Zynq-AXI-DMA%E5%9B%9E%E7%8E%AF%E5%BC%80%E5%8F%91%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://zhangkuang.asia/2025/08/05/Xilinx-Zynq-AXI-DMA%E5%9B%9E%E7%8E%AF%E5%BC%80%E5%8F%91%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/","path":"2025/08/05/Xilinx-Zynq-AXI-DMA回环开发完整指南/","title":"Xilinx Zynq AXI DMA回环开发完整指南"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Xilinx Zynq AXI DMA回环开发完整指南 | Kuang's Tech Log</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/6.0.5/fancybox/fancybox.umd.js" integrity="sha256-UiSieVaV/DXce2LW7QH+o77w+AIoAvSCPBkezriZ2DQ=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>




  <script src="/js/third-party/fancybox.js" defer></script>



  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Kuang's Tech Log</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">任何资源链接问题或者技术问题欢迎邮件联系讨论</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">目标系统配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="nav-number">3.</span> <span class="nav-text">核心名词解释</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AXI-DMA%E7%9B%B8%E5%85%B3"><span class="nav-number">3.1.</span> <span class="nav-text">AXI DMA相关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6"><span class="nav-number">3.2.</span> <span class="nav-text">系统框架</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5-%E7%B3%BB%E7%BB%9F%E7%BC%96%E8%AF%91"><span class="nav-number">4.</span> <span class="nav-text">第一阶段:系统编译</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E5%88%9B%E5%BB%BAPetaLinux%E9%A1%B9%E7%9B%AE"><span class="nav-number">4.1.</span> <span class="nav-text">第一步:创建PetaLinux项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E5%AF%BC%E5%85%A5%E7%A1%AC%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">4.2.</span> <span class="nav-text">第二步:导入硬件配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.</span> <span class="nav-text">第三步:系统配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.1.</span> <span class="nav-text">缓存配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E4%B8%BASD%E5%8D%A1"><span class="nav-number">4.3.2.</span> <span class="nav-text">启动配置为SD卡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%B2%E5%8F%A3%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.3.</span> <span class="nav-text">串口配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A5%E5%A4%AA%E7%BD%91%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.4.</span> <span class="nav-text">以太网配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.5.</span> <span class="nav-text">启动参数配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5-%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE"><span class="nav-number">4.4.</span> <span class="nav-text">第四步:内核配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DMA%E5%BC%95%E6%93%8E%E6%94%AF%E6%8C%81"><span class="nav-number">4.4.1.</span> <span class="nav-text">DMA引擎支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UIO%E6%94%AF%E6%8C%81-%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4IO%E8%AE%BF%E9%97%AE"><span class="nav-number">4.4.2.</span> <span class="nav-text">UIO支持(用户空间IO访问)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A5%E5%A4%AA%E7%BD%91%E9%A9%B1%E5%8A%A8"><span class="nav-number">4.4.3.</span> <span class="nav-text">以太网驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PHY%E9%A9%B1%E5%8A%A8-%E5%85%B3%E9%94%AE"><span class="nav-number">4.4.4.</span> <span class="nav-text">PHY驱动(关键!)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5-%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="nav-number">4.5.</span> <span class="nav-text">第五步:根文件系统配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%B3%BB%E7%BB%9F"><span class="nav-number">4.5.1.</span> <span class="nav-text">基础系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E6%94%AF%E6%8C%81"><span class="nav-number">4.5.2.</span> <span class="nav-text">网络支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E7%99%BB%E5%BD%95%E9%85%8D%E7%BD%AE-%E9%87%8D%E8%A6%81"><span class="nav-number">4.5.3.</span> <span class="nav-text">自动登录配置(重要!)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5-%E8%AE%BE%E5%A4%87%E6%A0%91%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">4.6.</span> <span class="nav-text">第六步:设备树文件配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5-%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA"><span class="nav-number">4.7.</span> <span class="nav-text">第七步:系统构建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5-%E7%94%9F%E6%88%90%E5%90%AF%E5%8A%A8%E9%95%9C%E5%83%8F"><span class="nav-number">4.8.</span> <span class="nav-text">第八步:生成启动镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B9%9D%E6%AD%A5-SD%E5%8D%A1%E5%88%B6%E4%BD%9C"><span class="nav-number">4.9.</span> <span class="nav-text">第九步:SD卡制作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5-%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF%E5%92%8C%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF%E7%A1%AE%E8%AE%A4"><span class="nav-number">5.</span> <span class="nav-text">第二阶段:项目背景和硬件信息确认</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90"><span class="nav-number">5.1.</span> <span class="nav-text">硬件设计分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E5%85%B3%E7%B3%BB"><span class="nav-number">5.1.1.</span> <span class="nav-text">连接关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E8%BF%9E%E6%8E%A5"><span class="nav-number">5.1.2.</span> <span class="nav-text">中断连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E5%8F%82%E6%95%B0"><span class="nav-number">5.1.3.</span> <span class="nav-text">关键参数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5-%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF%E5%8F%91%E7%8E%B0"><span class="nav-number">6.</span> <span class="nav-text">第三阶段:硬件信息发现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A41-%E6%9F%A5%E6%89%BE%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BF%A1%E6%81%AF"><span class="nav-number">6.1.</span> <span class="nav-text">步骤1:查找设备树信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%91%BD%E4%BB%A4"><span class="nav-number">6.1.1.</span> <span class="nav-text">核心命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90%E7%BB%93%E6%9E%9C"><span class="nav-number">6.1.2.</span> <span class="nav-text">解析结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42-%E4%B8%AD%E6%96%AD%E5%8F%B7%E8%BD%AC%E6%8D%A2%E8%A7%84%E5%88%99"><span class="nav-number">6.2.</span> <span class="nav-text">步骤2:中断号转换规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="nav-number">6.2.1.</span> <span class="nav-text">重要概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E6%98%A0%E5%B0%84"><span class="nav-number">6.2.2.</span> <span class="nav-text">实际映射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A43-%E9%AA%8C%E8%AF%81%E9%A9%B1%E5%8A%A8%E7%8A%B6%E6%80%81"><span class="nav-number">6.3.</span> <span class="nav-text">步骤3:验证驱动状态</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5-%E8%AE%BE%E5%A4%87%E6%A0%91%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9"><span class="nav-number">7.</span> <span class="nav-text">第四阶段:设备树配置修改</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#FIFO%E6%B7%B1%E5%BA%A6%E4%B8%8E%E4%BC%A0%E8%BE%93%E5%85%B3%E7%B3%BB%E5%88%86%E6%9E%90"><span class="nav-number">7.1.</span> <span class="nav-text">FIFO深度与传输关系分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E8%B7%AF4K%E8%A7%86%E9%A2%91%E5%86%85%E5%AD%98%E9%9C%80%E6%B1%82"><span class="nav-number">7.2.</span> <span class="nav-text">多路4K视频内存需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E9%85%8D%E7%BD%AE"><span class="nav-number">7.3.</span> <span class="nav-text">设备树配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B"><span class="nav-number">7.4.</span> <span class="nav-text">编译流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%98%B6%E6%AE%B5-UIO%E8%AE%BE%E5%A4%87%E9%AA%8C%E8%AF%81"><span class="nav-number">8.</span> <span class="nav-text">第五阶段:UIO设备验证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%AD%A5%E9%AA%A4"><span class="nav-number">8.1.</span> <span class="nav-text">验证步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%98%A0%E5%B0%84%E7%BB%93%E6%9E%9C"><span class="nav-number">8.2.</span> <span class="nav-text">设备映射结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMA%E5%86%85%E5%AD%98%E9%AA%8C%E8%AF%81"><span class="nav-number">8.3.</span> <span class="nav-text">CMA内存验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%98%B6%E6%AE%B5-C-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91"><span class="nav-number">9.</span> <span class="nav-text">第六阶段:C++应用程序开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">9.1.</span> <span class="nav-text">完整代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E8%AF%A6%E7%BB%86%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.</span> <span class="nav-text">代码详细解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"><span class="nav-number">9.2.1.</span> <span class="nav-text">代码架构概览</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="nav-number">9.2.1.1.</span> <span class="nav-text">整体设计思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.2.</span> <span class="nav-text">类成员变量解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E8%B5%84%E6%BA%90%E6%8A%BD%E8%B1%A1"><span class="nav-number">9.2.2.1.</span> <span class="nav-text">硬件资源抽象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80"><span class="nav-number">9.2.2.2.</span> <span class="nav-text">为什么需要物理地址</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E5%AE%9A%E4%B9%89%E5%92%8C%E7%A1%AC%E4%BB%B6%E6%98%A0%E5%B0%84"><span class="nav-number">9.2.3.</span> <span class="nav-text">寄存器定义和硬件映射</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AXI-DMA%E5%AF%84%E5%AD%98%E5%99%A8%E5%B8%83%E5%B1%80"><span class="nav-number">9.2.3.1.</span> <span class="nav-text">AXI DMA寄存器布局</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E4%BD%8D%E5%AE%9A%E4%B9%89%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.3.2.</span> <span class="nav-text">控制位定义解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E8%AF%A6%E7%BB%86%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.4.</span> <span class="nav-text">构造函数详细解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BA%8F%E5%88%97"><span class="nav-number">9.2.4.1.</span> <span class="nav-text">初始化序列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UIO%E8%AE%BE%E5%A4%87%E6%89%93%E5%BC%80"><span class="nav-number">9.2.4.2.</span> <span class="nav-text">UIO设备打开</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E7%A9%BA%E9%97%B4%E6%98%A0%E5%B0%84"><span class="nav-number">9.2.4.3.</span> <span class="nav-text">寄存器空间映射</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.5.</span> <span class="nav-text">内存分配策略深度解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CMA%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%8E%9F%E7%90%86"><span class="nav-number">9.2.5.1.</span> <span class="nav-text">CMA内存分配原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A90x38000000%EF%BC%9F"><span class="nav-number">9.2.5.2.</span> <span class="nav-text">为什么选择0x38000000？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E9%94%81%E5%AE%9A%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7"><span class="nav-number">9.2.5.3.</span> <span class="nav-text">内存锁定的重要性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.6.</span> <span class="nav-text">寄存器操作函数解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB%E5%AF%84%E5%AD%98%E5%99%A8%E5%87%BD%E6%95%B0"><span class="nav-number">9.2.6.1.</span> <span class="nav-text">读寄存器函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99%E5%AF%84%E5%AD%98%E5%99%A8%E5%87%BD%E6%95%B0"><span class="nav-number">9.2.6.2.</span> <span class="nav-text">写寄存器函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82"><span class="nav-number">9.2.6.3.</span> <span class="nav-text">关键技术细节</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DMA%E5%A4%8D%E4%BD%8D%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.7.</span> <span class="nav-text">DMA复位流程解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E4%BD%8D%E5%BA%8F%E5%88%97"><span class="nav-number">9.2.7.1.</span> <span class="nav-text">复位序列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E4%BD%8D%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.7.2.</span> <span class="nav-text">复位流程解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DMA%E4%BC%A0%E8%BE%93%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91"><span class="nav-number">9.2.8.</span> <span class="nav-text">DMA传输核心逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%A0%E8%BE%93%E5%90%AF%E5%8A%A8%E5%BA%8F%E5%88%97"><span class="nav-number">9.2.8.1.</span> <span class="nav-text">传输启动序列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1%E5%86%B3%E7%AD%96%E8%A7%A3%E6%9E%90"><span class="nav-number">9.2.8.2.</span> <span class="nav-text">关键设计决策解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7%E5%92%8C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">9.2.9.</span> <span class="nav-text">状态监控和错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E6%A3%80%E6%B5%8B%E9%80%BB%E8%BE%91"><span class="nav-number">9.2.9.1.</span> <span class="nav-text">完成检测逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E6%A3%80%E6%B5%8B%E7%AD%96%E7%95%A5"><span class="nav-number">9.2.9.2.</span> <span class="nav-text">状态检测策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E9%87%8F"><span class="nav-number">9.2.10.</span> <span class="nav-text">性能测量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="nav-number">9.2.11.</span> <span class="nav-text">数据验证机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A3%80%E6%9F%A5"><span class="nav-number">9.2.11.1.</span> <span class="nav-text">完整性检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E7%AD%96%E7%95%A5"><span class="nav-number">9.2.11.2.</span> <span class="nav-text">验证策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8CRAII"><span class="nav-number">9.2.12.</span> <span class="nav-text">资源管理和RAII</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="nav-number">9.2.12.1.</span> <span class="nav-text">析构函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RAII%E5%8E%9F%E5%88%99%E4%BD%93%E7%8E%B0"><span class="nav-number">9.2.12.2.</span> <span class="nav-text">RAII原则体现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6"><span class="nav-number">9.2.13.</span> <span class="nav-text">主函数测试框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%AD%96%E7%95%A5%E8%AE%BE%E8%AE%A1"><span class="nav-number">9.2.13.1.</span> <span class="nav-text">测试策略设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B8%90%E8%BF%9B%E5%BC%8F%E6%B5%8B%E8%AF%95%E7%9A%84%E6%84%8F%E4%B9%89"><span class="nav-number">9.2.13.2.</span> <span class="nav-text">渐进式测试的意义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="nav-number">9.2.13.3.</span> <span class="nav-text">错误处理策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">9.2.14.</span> <span class="nav-text">性能测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-number">9.2.14.1.</span> <span class="nav-text">性能测试结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%9E%E5%90%90%E9%87%8F%E5%88%86%E6%9E%90"><span class="nav-number">9.2.14.2.</span> <span class="nav-text">吞吐量分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E7%89%B9%E7%82%B9%E5%88%86%E6%9E%90"><span class="nav-number">9.2.14.3.</span> <span class="nav-text">性能特点分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E5%AF%84%E5%AD%98%E5%99%A8%E8%A7%A3%E8%AF%BB"><span class="nav-number">9.2.14.4.</span> <span class="nav-text">状态寄存器解读</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98%E8%A7%A3%E7%AD%94"><span class="nav-number">10.</span> <span class="nav-text">关键问题解答</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%981-%E8%AE%BE%E5%A4%87%E6%A0%91%E4%B8%AD%E6%96%AD%E4%BF%A1%E6%81%AF%E8%A7%A3%E6%9E%90"><span class="nav-number">10.1.</span> <span class="nav-text">问题1:设备树中断信息解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%982-UIO%E6%96%B9%E6%A1%88%E6%80%A7%E8%83%BD%E5%BD%B1%E5%93%8D%E8%AF%84%E4%BC%B0"><span class="nav-number">10.2.</span> <span class="nav-text">问题2:UIO方案性能影响评估</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%983-DMA%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F%E9%87%8D%E8%A6%81%E6%80%A7"><span class="nav-number">10.3.</span> <span class="nav-text">问题3:DMA启动顺序重要性</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zzkuang"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Zzkuang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://gitee.com/zzkuang" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;zzkuang" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>Gitee</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zzkuang0516@163.com" title="E-Mail → mailto:zzkuang0516@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhangkuang.asia/2025/08/05/Xilinx-Zynq-AXI-DMA%E5%9B%9E%E7%8E%AF%E5%BC%80%E5%8F%91%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Zzkuang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kuang's Tech Log">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Xilinx Zynq AXI DMA回环开发完整指南 | Kuang's Tech Log">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Xilinx Zynq AXI DMA回环开发完整指南
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-05 22:44:50" itemprop="dateCreated datePublished" datetime="2025-08-05T22:44:50+08:00">2025-08-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-18 16:28:13" itemprop="dateModified" datetime="2025-08-18T16:28:13+08:00">2025-08-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul>
<li><strong>本文目标</strong>:本指南记录了在Xilinx Zynq-7020平台上实现AXI DMA回环测试的完整开发过程，包括从硬件设计确认到最终C++应用程序实现的全部步骤。硬件平台文件依赖<a href="/2025/07/21/Zynq-7000-%E5%AE%8C%E6%95%B4%E7%A1%AC%E4%BB%B6%E5%B9%B3%E5%8F%B0%E6%9E%84%E5%BB%BA%E4%B8%8E%E9%AA%8C%E8%AF%81%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/" title="Zynq-7000 完整硬件平台构建与验证权威指南">Zynq-7000-完整硬件平台构建与验证权威指南</a></li>
</ul>
<span id="more"></span>

<h1 id="目标系统配置"><a href="#目标系统配置" class="headerlink" title="目标系统配置"></a>目标系统配置</h1><ul>
<li><strong>硬件平台</strong>: XC7Z020-2CLG484I</li>
<li><strong>软件版本</strong>: Vivado&#x2F;Vitis&#x2F;Petalinux 2023.2</li>
<li><strong>系统内存</strong>: 1GB DDR3</li>
<li><strong>CMA内存</strong>: 256MB</li>
</ul>
<hr>
<h1 id="核心名词解释"><a href="#核心名词解释" class="headerlink" title="核心名词解释"></a>核心名词解释</h1><h2 id="AXI-DMA相关"><a href="#AXI-DMA相关" class="headerlink" title="AXI DMA相关"></a>AXI DMA相关</h2><ul>
<li><strong>AXI DMA</strong>: Advanced eXtensible Interface Direct Memory Access，Xilinx提供的高性能DMA IP核</li>
<li><strong>MM2S</strong>: Memory-Mapped to Stream，内存到流方向的DMA传输通道</li>
<li><strong>S2MM</strong>: Stream to Memory-Mapped，流到内存方向的DMA传输通道</li>
<li><strong>AXI4-Stream</strong>: 高速流式数据传输协议，适用于数据流应用</li>
</ul>
<h2 id="系统框架"><a href="#系统框架" class="headerlink" title="系统框架"></a>系统框架</h2><ul>
<li><p><strong>DMA</strong>: DMA控制器是独立的硬件单元，它直接连接到内存总线，绕过CPU进行数据传输。DMA硬件内部没有地址翻译单元(MMU)，因此<strong>只能理解和使用物理地址</strong></p>
</li>
<li><p><strong>虚拟内存</strong>:虚拟内存是操作系统为用户程序提供的抽象，它存在于软件层面。硬件设备无法访问这个软件抽象层</p>
<ul>
<li>每个程序都以为自己独占整个内存,实际上是操作系统的障眼法,通过MMU(内存管理单元)翻译成物理地址</li>
</ul>
</li>
<li><p><strong>物理内存</strong>:真实的DDR内存芯片的地址</p>
</li>
<li><p><strong>UIO</strong>: Userspace I&#x2F;O，Linux内核框架，允许用户空间直接访问硬件寄存器</p>
</li>
<li><p><strong>CMA</strong>: Contiguous Memory Allocator，连续内存分配器，为DMA提供连续物理内存,对应设备树的如下配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reserved-memory &#123;</span><br><span class="line">    dma_4k_pool: dma-pool@<span class="number">30000000</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;shared-dma-pool&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x30000000</span> <span class="number">0x10000000</span>&gt;;  <span class="comment">// 256MB</span></span><br><span class="line">        reusable;</span><br><span class="line">        linux,cma-<span class="keyword">default</span>;  <span class="comment">// ← 这里启用了CMA</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>普通的内存分配包括<code>/dev/mem</code>在内,无法保证物理地址的连续性。Linux内核会将物理内存分割成小块分配给不同程序，导致物理内存碎片化。<strong>DMA传输通常需要大块连续的物理内存</strong>，如果内存不连续，DMA硬件无法正确传输数据</li>
<li>直接使用<code>/dev/mem</code>访问任意物理地址，可能会意外覆盖正在使用的内核内存,出现数据安全问题,CMA预留区域确保这块内存专门给DMA使用，不会被内核或其他程序占用</li>
</ul>
</li>
<li><p><strong>DMAEngine</strong>: Linux内核的统一DMA管理框架</p>
</li>
<li><p><strong>Device Tree</strong>: 设备树，描述硬件配置的数据结构</p>
</li>
</ul>
<hr>
<h1 id="第一阶段-系统编译"><a href="#第一阶段-系统编译" class="headerlink" title="第一阶段:系统编译"></a>第一阶段:系统编译</h1><h2 id="第一步-创建PetaLinux项目"><a href="#第一步-创建PetaLinux项目" class="headerlink" title="第一步:创建PetaLinux项目"></a>第一步:创建PetaLinux项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建基于Zynq模板的项目</span></span><br><span class="line">petalinux-create --<span class="built_in">type</span> project --template zynq --name zynq_linux_project</span><br><span class="line"><span class="built_in">cd</span> zynq_linux_project</span><br></pre></td></tr></table></figure>

<p><strong>说明:</strong> 选择zynq模板为Zynq 7000系列芯片提供基础配置框架。</p>
<h2 id="第二步-导入硬件配置"><a href="#第二步-导入硬件配置" class="headerlink" title="第二步:导入硬件配置"></a>第二步:导入硬件配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建硬件文件目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p hardware</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将Vivado生成的.xsa文件放入hardware目录</span></span><br><span class="line"><span class="comment"># 导入硬件配置</span></span><br><span class="line">petalinux-config --get-hw-description=./hardware/</span><br></pre></td></tr></table></figure>

<p><strong>重要事项:</strong></p>
<ul>
<li>使用相对路径导入，确保路径正确性</li>
<li>如果弹出配置菜单，通常可以直接保存退出</li>
<li>导入后会在 <code>project-spec/hw-description/</code> 生成硬件信息</li>
</ul>
<h2 id="第三步-系统配置"><a href="#第三步-系统配置" class="headerlink" title="第三步:系统配置"></a>第三步:系统配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">petalinux-config</span><br></pre></td></tr></table></figure>

<p><strong>关键配置项:</strong></p>
<h3 id="缓存配置"><a href="#缓存配置" class="headerlink" title="缓存配置"></a>缓存配置</h3><p>参考<a href="/2025/07/31/PetaLinux-2023-2-%E7%A6%BB%E7%BA%BF%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E9%80%9F%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE/" title="PetaLinux 2023.2 离线缓存与加速编译配置">PetaLinux-2023-2-离线缓存与加速编译配置</a></p>
<h3 id="启动配置为SD卡"><a href="#启动配置为SD卡" class="headerlink" title="启动配置为SD卡"></a>启动配置为SD卡</h3><ul>
<li><strong>路径:</strong> <code>Subsystem AUTO Hardware Settings</code> -&gt; <code>SD/SDIO Settings</code></li>
<li><strong>设置:</strong> 确认 <code>Primary SD/SDIO (ps7_sd_0)</code> 已选择</li>
<li><code>Image Packaging Configuration -&gt; Root filesystem type</code>,从 <code>INITRD</code> 改为 <code>EXT4 (SD/eMMC/SATA/USB)</code></li>
</ul>
<h3 id="串口配置"><a href="#串口配置" class="headerlink" title="串口配置"></a>串口配置</h3><ul>
<li><strong>路径:</strong> <code>Subsystem AUTO Hardware Settings</code> -&gt; <code>Serial Settings</code></li>
<li>配置(此处是因为开发板的底板串口为串口1,此处配置要看开发板):<ul>
<li><code>FSBL Serial stdin/stdout (ps7_uart_1)</code></li>
<li><code>DTG Serial stdin/stdout (ps7_uart_1)</code></li>
<li><code>System stdin/stdout baudrate for ps7_uart_1 (115200)</code></li>
</ul>
</li>
</ul>
<h3 id="以太网配置"><a href="#以太网配置" class="headerlink" title="以太网配置"></a>以太网配置</h3><ul>
<li><strong>路径:</strong> <code>Subsystem AUTO Hardware Settings</code> -&gt; <code>Ethernet Settings</code></li>
<li>配置:<ul>
<li><code>Primary Ethernet (ps7_ethernet_0)</code> - 确认已选择</li>
<li><code>[*] Obtain IP address automatically</code> - 启用DHCP</li>
<li>MAC地址保持默认即可</li>
</ul>
</li>
</ul>
<h3 id="启动参数配置"><a href="#启动参数配置" class="headerlink" title="启动参数配置"></a>启动参数配置</h3><ul>
<li><p>路径: <code>DTG Settings -&gt; Kernel Bootargs</code>设置为手动设置参数,设置如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console=ttyPS0,115200 earlycon root=/dev/mmcblk0p2 ro rootwait uio_pdrv_genirq.of_id=generic-uio</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="第四步-内核配置"><a href="#第四步-内核配置" class="headerlink" title="第四步:内核配置"></a>第四步:内核配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">petalinux-config -c kernel</span><br></pre></td></tr></table></figure>

<p><strong>必需启用的驱动模块:</strong></p>
<h3 id="DMA引擎支持"><a href="#DMA引擎支持" class="headerlink" title="DMA引擎支持"></a>DMA引擎支持</h3><ul>
<li><strong>路径:</strong> <code>Device Drivers</code> -&gt; <code>DMA Engine support</code></li>
<li><strong>启用:</strong> <code>&lt;*&gt; Xilinx AXI DMAS Engine</code></li>
<li><strong>状态:</strong> 通常默认已启用</li>
</ul>
<h3 id="UIO支持-用户空间IO访问"><a href="#UIO支持-用户空间IO访问" class="headerlink" title="UIO支持(用户空间IO访问)"></a>UIO支持(用户空间IO访问)</h3><ul>
<li><p><strong>路径:</strong> <code>Device Drivers</code> -&gt; <code>Userspace I/O drivers</code></p>
</li>
<li><p>必须启用:</p>
<ul>
<li><code>&lt;M&gt; Userspace I/O platform driver with generic IRQ handling</code>,该项无法修改为<code>*</code></li>
<li><code>&lt;*&gt; Userspace platform driver with generic irq and dynamic memory</code></li>
</ul>
</li>
<li><p><strong>重要性:</strong> 用于用户空间访问BRAM控制器等自定义IP</p>
</li>
<li><p><strong>UIO驱动的作用</strong></p>
<ul>
<li><p><strong>Userspace I&#x2F;O (UIO)</strong> 的优势:</p>
<ul>
<li><p>允许用户空间程序直接访问硬件寄存器</p>
</li>
<li><p>避免编写复杂的内核驱动</p>
</li>
<li><p>适用于自定义IP核的快速原型开发</p>
</li>
<li><p>支持中断处理和内存映射</p>
</li>
</ul>
</li>
<li><p><strong>适用场景:</strong></p>
<ul>
<li>BRAM控制器的用户空间访问</li>
<li>自定义AXI IP核的控制</li>
<li>硬件加速器的用户空间接口</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="以太网驱动"><a href="#以太网驱动" class="headerlink" title="以太网驱动"></a>以太网驱动</h3><ul>
<li><strong>路径:</strong> <code>Device Drivers</code> -&gt; <code>Network device support</code> -&gt; <code>Ethernet driver support</code></li>
<li><strong>启用:</strong> <code>&lt;*&gt; Xilinx 10/100/1000 AXI Ethernet support</code></li>
</ul>
<h3 id="PHY驱动-关键"><a href="#PHY驱动-关键" class="headerlink" title="PHY驱动(关键!)"></a>PHY驱动(关键!)</h3><ul>
<li><strong>路径:</strong> <code>Device Drivers</code> -&gt; <code>Network device support</code> -&gt; <code>PHY Device support and infrastructure</code></li>
<li><strong>必须启用:</strong> <code>[*] Micrel Phys</code></li>
<li><strong>重要性:</strong> 没有正确的PHY驱动，网卡无法工作</li>
</ul>
<h2 id="第五步-根文件系统配置"><a href="#第五步-根文件系统配置" class="headerlink" title="第五步:根文件系统配置"></a>第五步:根文件系统配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">petalinux-config -c rootfs</span><br></pre></td></tr></table></figure>

<p><strong>推荐配置:</strong></p>
<h3 id="基础系统"><a href="#基础系统" class="headerlink" title="基础系统"></a>基础系统</h3><ul>
<li>路径: <code>Filesystem Packages  -&gt; base  -&gt; busybox</code></li>
</ul>
<ul>
<li><code>[*] busybox</code> - 基础系统工具集</li>
<li><code>[*] busybox-udhcpc</code> - DHCP客户端(用于自动获取IP)</li>
</ul>
<h3 id="网络支持"><a href="#网络支持" class="headerlink" title="网络支持"></a>网络支持</h3><ul>
<li>SSH服务默认已配置，无需额外设置</li>
</ul>
<h3 id="自动登录配置-重要"><a href="#自动登录配置-重要" class="headerlink" title="自动登录配置(重要!)"></a>自动登录配置(重要!)</h3><ul>
<li><strong>路径:</strong> <code>Image Features</code></li>
<li>必须启用,在该开发板上使用UART1登录时root密码登录会出现一直失败的情况,可能是BUG:<ul>
<li><code>-*- empty-root-password</code> - 设置root用户空密码</li>
<li><code>[*] serial-autologin-root</code> - 串口自动以root身份登录</li>
</ul>
</li>
</ul>
<h2 id="第六步-设备树文件配置"><a href="#第六步-设备树文件配置" class="headerlink" title="第六步:设备树文件配置"></a>第六步:设备树文件配置</h2><ul>
<li><p>编辑 <code>project-spec/meta-user/recipes-bsp/device-tree/files/system-user.dtsi</code></p>
</li>
<li><p>添加如下内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/include/ <span class="string">&quot;system-conf.dtsi&quot;</span></span><br><span class="line"></span><br><span class="line">/ &#123;</span><br><span class="line">    reserved-memory &#123;</span><br><span class="line">        <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">        <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">        ranges;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 为多路4K视频处理预留256MB CMA内存</span></span><br><span class="line">        dma_4k_pool: dma-pool@<span class="number">30000000</span> &#123;</span><br><span class="line">            compatible = <span class="string">&quot;shared-dma-pool&quot;</span>;</span><br><span class="line">            reg = &lt;<span class="number">0x30000000</span> <span class="number">0x10000000</span>&gt;;  <span class="comment">// 256MB</span></span><br><span class="line">            reusable;</span><br><span class="line">            linux,cma-<span class="keyword">default</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UIO设备绑定</span></span><br><span class="line">&amp;axi_bram_ctrl_0 &#123;</span><br><span class="line">    compatible = <span class="string">&quot;generic-uio&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;axi_bram_ctrl_1 &#123;</span><br><span class="line">    compatible = <span class="string">&quot;generic-uio&quot;</span>;  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;axi_cdma_0 &#123;</span><br><span class="line">    compatible = <span class="string">&quot;generic-uio&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;axi_dma_0 &#123;</span><br><span class="line">    compatible = <span class="string">&quot;generic-uio&quot;</span>;  <span class="comment">// 从xilinx驱动改为UIO</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设备树配置原理</p>
<ul>
<li><code>compatible = &quot;generic-uio&quot;</code>: 告诉Linux使用UIO框架</li>
<li>UIO框架自动创建<code>/dev/uioX</code>设备文件</li>
<li>支持用户空间直接访问硬件寄存器和中断</li>
</ul>
</li>
</ul>
<h2 id="第七步-系统构建"><a href="#第七步-系统构建" class="headerlink" title="第七步:系统构建"></a>第七步:系统构建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 完整构建(首次构建20-60分钟)</span></span><br><span class="line">petalinux-build</span><br></pre></td></tr></table></figure>

<p><strong>构建说明:</strong></p>
<ul>
<li>首次构建会下载并编译大量软件包</li>
<li>构建过程包括:内核编译、根文件系统生成、设备树编译等</li>
<li>如果出现网络下载错误，根据URL下载并补充在downloads目录下,详情参考<a href="/2025/07/31/PetaLinux-2023-2-%E7%A6%BB%E7%BA%BF%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E9%80%9F%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE/" title="PetaLinux 2023.2 离线缓存与加速编译配置">PetaLinux-2023-2-离线缓存与加速编译配置</a></li>
</ul>
<h2 id="第八步-生成启动镜像"><a href="#第八步-生成启动镜像" class="headerlink" title="第八步:生成启动镜像"></a>第八步:生成启动镜像</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打包启动镜像</span></span><br><span class="line">petalinux-package --boot --fsbl images/linux/zynq_fsbl.elf --fpga images/linux/system.bit --u-boot --force</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证生成的文件</span></span><br><span class="line">ls -la images/linux/BOOT.BIN images/linux/image.ub images/linux/boot.scr</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>生成的关键文件:</strong><ul>
<li><code>BOOT.BIN</code> (~5MB) - 包含FSBL、FPGA比特流、U-Boot、设备树</li>
<li><code>image.ub</code> (~76MB) - FIT格式，包含Linux内核和根文件系统</li>
<li><code>boot.scr</code> (~3.5KB) - U-Boot启动脚本</li>
</ul>
</li>
<li>注意,2023.2版本似乎不会在后续编译的时候生成boot.scr,因此该文件时间在后续构建是旧的</li>
</ul>
<h2 id="第九步-SD卡制作"><a href="#第九步-SD卡制作" class="headerlink" title="第九步:SD卡制作"></a>第九步:SD卡制作</h2><ul>
<li><p>先查看自己的sd卡名称,我的设备是sdb1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk -l</span><br></pre></td></tr></table></figure>
</li>
<li><p>挂载SD卡分区(需要提前分区:FAT32启动分区 + EXT4根文件系统分区)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sdb1 /mnt/boot </span><br><span class="line">sudo mount /dev/sdb2 /mnt/rootfs</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制启动文件到boot分区,解压根文件系统到rootfs分区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cp images/linux/BOOT.BIN /mnt/boot/</span><br><span class="line">sudo cp images/linux/image.ub /mnt/boot/</span><br><span class="line">sudo cp images/linux/boot.scr /mnt/boot/</span><br><span class="line">sudo tar -xzf images/linux/rootfs.tar.gz -C /mnt/rootfs/</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步并卸载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sync</span><br><span class="line">sudo umount /mnt/boot /mnt/rootfs</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="第二阶段-项目背景和硬件信息确认"><a href="#第二阶段-项目背景和硬件信息确认" class="headerlink" title="第二阶段:项目背景和硬件信息确认"></a>第二阶段:项目背景和硬件信息确认</h1><h2 id="硬件设计分析"><a href="#硬件设计分析" class="headerlink" title="硬件设计分析"></a>硬件设计分析</h2><h3 id="连接关系"><a href="#连接关系" class="headerlink" title="连接关系"></a>连接关系</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AXI DMA连接关系:</span><br><span class="line">├── S_AXI_LITE → AXI SMARTConnect M04_AXI (控制接口)</span><br><span class="line">├── M_AXI_MM2S → AXI SMARTConnect S02AXI (内存读取)</span><br><span class="line">├── M_AXI_S2MM → AXI SMARTConnect S03AXI (内存写入)</span><br><span class="line">└── 数据回环路径:</span><br><span class="line">    MM2S → M_AXIS_MM2S → AXI4Stream Data FIFO → S_AXIS_S2MM</span><br></pre></td></tr></table></figure>

<h3 id="中断连接"><a href="#中断连接" class="headerlink" title="中断连接"></a>中断连接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">中断处理链路:</span><br><span class="line">├── mm2s_introut → xlconcat In2</span><br><span class="line">├── s2mm_introut → xlconcat In3</span><br><span class="line">└── xlconcat → IRQ_F2P</span><br></pre></td></tr></table></figure>

<h3 id="关键参数"><a href="#关键参数" class="headerlink" title="关键参数"></a>关键参数</h3><ul>
<li><strong>FIFO深度</strong>: 1024 (32位宽度，最大缓冲4KB)</li>
<li><strong>地址空间</strong>: 0x40400000 - 0x4040FFFF (64KB)</li>
<li><strong>开发方案</strong>: UIO + CMA混合方案(用户空间完全控制，适合生产环境)</li>
</ul>
<hr>
<h1 id="第三阶段-硬件信息发现"><a href="#第三阶段-硬件信息发现" class="headerlink" title="第三阶段:硬件信息发现"></a>第三阶段:硬件信息发现</h1><h2 id="步骤1-查找设备树信息"><a href="#步骤1-查找设备树信息" class="headerlink" title="步骤1:查找设备树信息"></a>步骤1:查找设备树信息</h2><h3 id="核心命令"><a href="#核心命令" class="headerlink" title="核心命令"></a>核心命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看设备树结构</span></span><br><span class="line"><span class="built_in">ls</span> /proc/device-tree/amba_pl*/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找DMA设备节点</span></span><br><span class="line">find /proc/device-tree -name <span class="string">&quot;*dma*&quot;</span> -<span class="built_in">type</span> d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看设备属性</span></span><br><span class="line"><span class="built_in">cat</span> /proc/device-tree/amba_pl*/dma@40400000/compatible</span><br><span class="line"><span class="built_in">cat</span> /proc/device-tree/amba_pl*/dma@40400000/reg | hexdump -C</span><br><span class="line"><span class="built_in">cat</span> /proc/device-tree/amba_pl*/dma@40400000/interrupts | hexdump -C</span><br></pre></td></tr></table></figure>

<h3 id="解析结果"><a href="#解析结果" class="headerlink" title="解析结果"></a>解析结果</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">设备发现结果:</span><br><span class="line">├── dma@40400000 (AXI DMA) - 目标设备</span><br><span class="line">│   ├── 物理地址: 0x40400000</span><br><span class="line">│   ├── 地址空间: 64KB</span><br><span class="line">│   ├── 兼容性: xlnx,axi-dma-7.1</span><br><span class="line">│   └── 中断: 31(MM2S), 32(S2MM)</span><br><span class="line">└── dma@7e200000 (AXI CDMA)</span><br><span class="line">    ├── 物理地址: 0x7e200000  </span><br><span class="line">    └── 中断: 29</span><br></pre></td></tr></table></figure>

<h2 id="步骤2-中断号转换规则"><a href="#步骤2-中断号转换规则" class="headerlink" title="步骤2:中断号转换规则"></a>步骤2:中断号转换规则</h2><h3 id="重要概念"><a href="#重要概念" class="headerlink" title="重要概念"></a>重要概念</h3><p><strong>Linux中断号计算公式</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux中断号 = 设备树中断号 + 32</span><br></pre></td></tr></table></figure>

<h3 id="实际映射"><a href="#实际映射" class="headerlink" title="实际映射"></a>实际映射</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AXI DMA中断映射:</span><br><span class="line">├── MM2S: 31 + 32 = 63 (Linux中断号)</span><br><span class="line">└── S2MM: 32 + 32 = 64 (Linux中断号)</span><br></pre></td></tr></table></figure>

<h2 id="步骤3-验证驱动状态"><a href="#步骤3-验证驱动状态" class="headerlink" title="步骤3:验证驱动状态"></a>步骤3:验证驱动状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查驱动加载</span></span><br><span class="line">dmesg | grep -i <span class="string">&quot;40400000&quot;</span></span><br><span class="line"><span class="comment"># 输出: xilinx-vdma 40400000.dma: Xilinx AXI DMA Engine Driver Probed!!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查中断分配</span></span><br><span class="line"><span class="built_in">cat</span> /proc/interrupts | grep -E <span class="string">&quot;(63|64)&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第四阶段-设备树配置修改"><a href="#第四阶段-设备树配置修改" class="headerlink" title="第四阶段:设备树配置修改"></a>第四阶段:设备树配置修改</h1><h2 id="FIFO深度与传输关系分析"><a href="#FIFO深度与传输关系分析" class="headerlink" title="FIFO深度与传输关系分析"></a>FIFO深度与传输关系分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FIFO深度影响分析:</span><br><span class="line">├── FIFO深度: 1024 × 32位 = 4KB缓冲</span><br><span class="line">├── 传输能力: 不限制总传输大小</span><br><span class="line">├── 流控制: FIFO满时MM2S暂停，空时S2MM等待</span><br><span class="line">└── 测试策略:</span><br><span class="line">    ├── &lt; FIFO: 512B-2KB (基本功能)</span><br><span class="line">    ├── = FIFO: 4KB (满载测试)  </span><br><span class="line">    └── &gt; FIFO: 16KB-256KB (流控制)</span><br></pre></td></tr></table></figure>

<h2 id="多路4K视频内存需求"><a href="#多路4K视频内存需求" class="headerlink" title="多路4K视频内存需求"></a>多路4K视频内存需求</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">性能需求分析:</span><br><span class="line">├── 单路4K@30fps: ~16-32MB缓冲需求</span><br><span class="line">├── 双路4K@30fps: ~64-128MB缓冲需求</span><br><span class="line">├── 四路4K@30fps: ~256MB缓冲需求</span><br><span class="line">└── 系统配置: 1GB总内存，分配256MB给CMA</span><br></pre></td></tr></table></figure>

<h2 id="设备树配置"><a href="#设备树配置" class="headerlink" title="设备树配置"></a>设备树配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/include/ &quot;system-conf.dtsi&quot;</span><br><span class="line"></span><br><span class="line">/ &#123;</span><br><span class="line">    reserved-memory &#123;</span><br><span class="line">        #address-cells = &lt;1&gt;;</span><br><span class="line">        #size-cells = &lt;1&gt;;</span><br><span class="line">        ranges;</span><br><span class="line">        </span><br><span class="line">        // 为多路4K视频处理预留256MB CMA内存</span><br><span class="line">        dma_4k_pool: dma-pool@30000000 &#123;</span><br><span class="line">            compatible = &quot;shared-dma-pool&quot;;</span><br><span class="line">            reg = &lt;0x30000000 0x10000000&gt;;  // 256MB</span><br><span class="line">            reusable;</span><br><span class="line">            linux,cma-default;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// UIO设备绑定</span><br><span class="line">&amp;axi_bram_ctrl_0 &#123;</span><br><span class="line">    compatible = &quot;generic-uio&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;axi_bram_ctrl_1 &#123;</span><br><span class="line">    compatible = &quot;generic-uio&quot;;  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;axi_cdma_0 &#123;</span><br><span class="line">    compatible = &quot;generic-uio&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;axi_dma_0 &#123;</span><br><span class="line">    compatible = &quot;generic-uio&quot;;  // 从xilinx驱动改为UIO</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改设备树</span></span><br><span class="line">vi project-spec/meta-user/recipes-bsp/device-tree/files/system-user.dtsi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新构建</span></span><br><span class="line">petalinux-build -c device-tree</span><br><span class="line">petalinux-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包启动文件</span></span><br><span class="line">petalinux-package --boot --format BIN \</span><br><span class="line">    --fsbl images/linux/zynq_fsbl.elf \</span><br><span class="line">    --fpga images/linux/system.bit \</span><br><span class="line">    --u-boot images/linux/u-boot.elf --force</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第五阶段-UIO设备验证"><a href="#第五阶段-UIO设备验证" class="headerlink" title="第五阶段:UIO设备验证"></a>第五阶段:UIO设备验证</h1><h2 id="验证步骤"><a href="#验证步骤" class="headerlink" title="验证步骤"></a>验证步骤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 检查UIO设备节点</span></span><br><span class="line"><span class="built_in">ls</span> -la /dev/uio*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看设备映射</span></span><br><span class="line"><span class="built_in">cat</span> /sys/class/uio/uio*/name</span><br><span class="line"><span class="built_in">cat</span> /sys/class/uio/uio*/maps/map0/addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 确认设备对应关系</span></span><br></pre></td></tr></table></figure>

<h2 id="设备映射结果"><a href="#设备映射结果" class="headerlink" title="设备映射结果"></a>设备映射结果</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UIO设备映射表:</span><br><span class="line">├── uio0: axi_bram_ctrl @0x40000000 (4KB)</span><br><span class="line">├── uio1: axi_bram_ctrl @0x40001000 (4KB)</span><br><span class="line">├── uio2: dma (CDMA) @0x7e200000 (64KB)</span><br><span class="line">└── uio3: dma (AXI DMA) @0x40400000 (64KB) ← 目标设备</span><br></pre></td></tr></table></figure>

<h2 id="CMA内存验证"><a href="#CMA内存验证" class="headerlink" title="CMA内存验证"></a>CMA内存验证</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查CMA配置</span></span><br><span class="line"><span class="built_in">cat</span> /proc/meminfo | grep Cma</span><br><span class="line"><span class="comment"># 预期输出: CmaTotal: 262144 kB (256MB)</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第六阶段-C-应用程序开发"><a href="#第六阶段-C-应用程序开发" class="headerlink" title="第六阶段:C++应用程序开发"></a>第六阶段:C++应用程序开发</h1><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/dma-buf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief AXI DMA 回环测试程序 - 生产级实现</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 功能:</span></span><br><span class="line"><span class="comment"> * 1. UIO设备访问AXI DMA寄存器</span></span><br><span class="line"><span class="comment"> * 2. CMA内存分配DMA缓冲区</span></span><br><span class="line"><span class="comment"> * 3. MM2S -&gt; FIFO -&gt; S2MM 回环传输</span></span><br><span class="line"><span class="comment"> * 4. 中断处理和数据验证</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 硬件要求:</span></span><br><span class="line"><span class="comment"> * - AXI DMA @0x40400000 (UIO3)</span></span><br><span class="line"><span class="comment"> * - 256MB CMA内存池</span></span><br><span class="line"><span class="comment"> * - AXI4-Stream Data FIFO回环连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AXI_DMA_Controller</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// AXI DMA寄存器偏移地址</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_DMACR = <span class="number">0x00</span>;      <span class="comment">// MM2S DMA控制寄存器</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_DMASR = <span class="number">0x04</span>;      <span class="comment">// MM2S DMA状态寄存器</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_SA = <span class="number">0x18</span>;         <span class="comment">// MM2S源地址</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_SA_MSB = <span class="number">0x1C</span>;     <span class="comment">// MM2S源地址高32位</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_LENGTH = <span class="number">0x28</span>;     <span class="comment">// MM2S传输长度</span></span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_DMACR = <span class="number">0x30</span>;      <span class="comment">// S2MM DMA控制寄存器</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_DMASR = <span class="number">0x34</span>;      <span class="comment">// S2MM DMA状态寄存器</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_DA = <span class="number">0x48</span>;         <span class="comment">// S2MM目标地址</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_DA_MSB = <span class="number">0x4C</span>;     <span class="comment">// S2MM目标地址高32位</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_LENGTH = <span class="number">0x58</span>;     <span class="comment">// S2MM传输长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 控制寄存器位定义</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMACR_RS = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>);    <span class="comment">// Run/Stop</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMACR_RESET = (<span class="number">1</span> &lt;&lt; <span class="number">2</span>); <span class="comment">// Reset</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMACR_IOC_IRQEN = (<span class="number">1</span> &lt;&lt; <span class="number">12</span>); <span class="comment">// 中断完成使能</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMACR_ERR_IRQEN = (<span class="number">1</span> &lt;&lt; <span class="number">14</span>); <span class="comment">// 错误中断使能</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态寄存器位定义</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMASR_HALTED = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>);    <span class="comment">// DMA停止</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMASR_IDLE = (<span class="number">1</span> &lt;&lt; <span class="number">1</span>);      <span class="comment">// DMA空闲</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMASR_IOC_IRQ = (<span class="number">1</span> &lt;&lt; <span class="number">12</span>);  <span class="comment">// 传输完成中断</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMASR_ERR_IRQ = (<span class="number">1</span> &lt;&lt; <span class="number">14</span>);  <span class="comment">// 错误中断</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> uio_fd_;           <span class="comment">// UIO设备文件描述符</span></span><br><span class="line">    <span class="type">void</span>* reg_base_;       <span class="comment">// 寄存器映射基地址</span></span><br><span class="line">    <span class="type">int</span> cma_fd_;           <span class="comment">// CMA设备文件描述符</span></span><br><span class="line">    <span class="type">void</span>* dma_buffer_;     <span class="comment">// DMA缓冲区虚拟地址</span></span><br><span class="line">    <span class="type">uint64_t</span> dma_phys_;    <span class="comment">// DMA缓冲区物理地址</span></span><br><span class="line">    <span class="type">size_t</span> buffer_size_;   <span class="comment">// 缓冲区大小</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 构造函数 - 初始化AXI DMA控制器</span></span><br><span class="line"><span class="comment">     * @param buffer_size DMA缓冲区大小(字节)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">AXI_DMA_Controller</span><span class="params">(<span class="type">size_t</span> buffer_size = <span class="number">1024</span> * <span class="number">1024</span>)</span></span></span><br><span class="line"><span class="function">        : uio_fd_(<span class="number">-1</span>), reg_base_(MAP_FAILED), cma_fd_(<span class="number">-1</span>),</span></span><br><span class="line"><span class="function">          dma_buffer_(MAP_FAILED), buffer_size_(buffer_size) &#123;</span></span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;初始化AXI DMA控制器...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打开UIO设备 (uio3 = AXI DMA @0x40400000)</span></span><br><span class="line">        uio_fd_ = <span class="built_in">open</span>(<span class="string">&quot;/dev/uio3&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">        <span class="keyword">if</span> (uio_fd_ &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;无法打开UIO设备 /dev/uio3&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 映射AXI DMA寄存器空间</span></span><br><span class="line">        reg_base_ = <span class="built_in">mmap</span>(<span class="literal">nullptr</span>, <span class="number">0x10000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                        MAP_SHARED, uio_fd_, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (reg_base_ == MAP_FAILED) &#123;</span><br><span class="line">            <span class="built_in">close</span>(uio_fd_);</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;无法映射AXI DMA寄存器空间&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分配CMA内存作为DMA缓冲区</span></span><br><span class="line">        <span class="built_in">allocate_dma_buffer</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重置和初始化DMA控制器</span></span><br><span class="line">        <span class="built_in">reset_dma</span>();</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;AXI DMA控制器初始化完成!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;寄存器基地址: &quot;</span> &lt;&lt; reg_base_ &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;DMA缓冲区大小: &quot;</span> &lt;&lt; buffer_size_ &lt;&lt; <span class="string">&quot; 字节&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 析构函数 - 清理资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ~<span class="built_in">AXI_DMA_Controller</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (dma_buffer_ != MAP_FAILED) &#123;</span><br><span class="line">            <span class="built_in">munlock</span>(dma_buffer_, buffer_size_ * <span class="number">2</span>); <span class="comment">// 解锁内存</span></span><br><span class="line">            <span class="built_in">munmap</span>(dma_buffer_, buffer_size_ * <span class="number">2</span>); <span class="comment">// 源+目标缓冲区</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cma_fd_ &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">close</span>(cma_fd_);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (reg_base_ != MAP_FAILED) &#123;</span><br><span class="line">            <span class="built_in">munmap</span>(reg_base_, <span class="number">0x10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (uio_fd_ &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">close</span>(uio_fd_);</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;AXI DMA控制器已清理&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 分配CMA内存作为DMA缓冲区</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">allocate_dma_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 尝试使用CMA设备分配连续物理内存</span></span><br><span class="line">        cma_fd_ = <span class="built_in">open</span>(<span class="string">&quot;/dev/mem&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">        <span class="keyword">if</span> (cma_fd_ &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;无法打开 /dev/mem，请使用root权限运行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分配双倍大小:源缓冲区+目标缓冲区</span></span><br><span class="line">        <span class="type">size_t</span> total_size = buffer_size_ * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尝试从CMA区域分配 - 使用较高的CMA地址避免冲突</span></span><br><span class="line">        <span class="comment">// 根据前面的信息，CMA从0x30000000开始，我们从中间位置开始分配</span></span><br><span class="line">        <span class="type">uint64_t</span> cma_offset = <span class="number">0x38000000</span>; <span class="comment">// CMA区域的中间位置</span></span><br><span class="line"></span><br><span class="line">        dma_buffer_ = <span class="built_in">mmap</span>(<span class="literal">nullptr</span>, total_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                          MAP_SHARED, cma_fd_, cma_offset);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dma_buffer_ == MAP_FAILED) &#123;</span><br><span class="line">            <span class="built_in">close</span>(cma_fd_);</span><br><span class="line">            cma_fd_ = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 回退方案:使用普通内存分配</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;CMA分配失败，使用普通内存...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">            dma_buffer_ = <span class="built_in">mmap</span>(<span class="literal">nullptr</span>, total_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                              MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dma_buffer_ == MAP_FAILED) &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;无法分配DMA缓冲区&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对于普通内存，尝试获取物理地址</span></span><br><span class="line">            dma_phys_ = <span class="built_in">get_physical_address</span>(dma_buffer_);</span><br><span class="line">            <span class="keyword">if</span> (dma_phys_ == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 最后的回退:使用一个合理的CMA物理地址假设</span></span><br><span class="line">                dma_phys_ = <span class="number">0x38000000</span>;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;警告: 使用假设的CMA物理地址&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// CMA分配成功，物理地址就是偏移地址</span></span><br><span class="line">            dma_phys_ = cma_offset;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 锁定内存页面，防止交换</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">mlock</span>(dma_buffer_, total_size) != <span class="number">0</span>) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;警告: 无法锁定内存页面&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确保物理地址在32位范围内(Zynq-7020限制)</span></span><br><span class="line">        <span class="keyword">if</span> (dma_phys_ &gt; <span class="number">0xFFFFFFFFULL</span>) &#123;</span><br><span class="line">            dma_phys_ = <span class="number">0x38000000</span>; <span class="comment">// 使用安全的CMA地址</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;警告: 物理地址超出32位范围，使用默认CMA地址&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;DMA缓冲区分配成功:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  虚拟地址: &quot;</span> &lt;&lt; dma_buffer_ &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  物理地址: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; dma_phys_ &lt;&lt; std::dec &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  总大小: &quot;</span> &lt;&lt; total_size &lt;&lt; <span class="string">&quot; 字节&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 通过/proc/self/pagemap获取物理地址</span></span><br><span class="line"><span class="comment">     * @param virt_addr 虚拟地址</span></span><br><span class="line"><span class="comment">     * @return 物理地址，失败返回0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">uint64_t</span> <span class="title">get_physical_address</span><span class="params">(<span class="type">void</span>* virt_addr)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> fd = <span class="built_in">open</span>(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">uint64_t</span> page_size = <span class="built_in">getpagesize</span>();</span><br><span class="line">        <span class="type">uint64_t</span> virt_pfn = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint64_t</span>&gt;(virt_addr) / page_size;</span><br><span class="line"></span><br><span class="line">        <span class="type">uint64_t</span> entry;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">pread</span>(fd, &amp;entry, <span class="built_in">sizeof</span>(entry), virt_pfn * <span class="built_in">sizeof</span>(entry)) != <span class="built_in">sizeof</span>(entry)) &#123;</span><br><span class="line">            <span class="built_in">close</span>(fd);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(entry &amp; (<span class="number">1ULL</span> &lt;&lt; <span class="number">63</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 页面不存在</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">uint64_t</span> phys_pfn = entry &amp; ((<span class="number">1ULL</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="type">uint64_t</span> phys_addr = phys_pfn * page_size +</span><br><span class="line">                            (<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint64_t</span>&gt;(virt_addr) % page_size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> phys_addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 读取AXI DMA寄存器</span></span><br><span class="line"><span class="comment">     * @param offset 寄存器偏移地址</span></span><br><span class="line"><span class="comment">     * @return 寄存器值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">uint32_t</span> <span class="title">read_reg</span><span class="params">(<span class="type">uint32_t</span> offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">uint32_t</span>* reg_ptr = <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">volatile</span> <span class="type">uint32_t</span>*&gt;(</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;<span class="type">char</span>*&gt;(reg_base_) + offset);</span><br><span class="line">        <span class="keyword">return</span> *reg_ptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 写入AXI DMA寄存器</span></span><br><span class="line"><span class="comment">     * @param offset 寄存器偏移地址</span></span><br><span class="line"><span class="comment">     * @param value 要写入的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">write_reg</span><span class="params">(<span class="type">uint32_t</span> offset, <span class="type">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">uint32_t</span>* reg_ptr = <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">volatile</span> <span class="type">uint32_t</span>*&gt;(</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;<span class="type">char</span>*&gt;(reg_base_) + offset);</span><br><span class="line">        *reg_ptr = value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确保写入完成</span></span><br><span class="line">        <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;dsb sy&quot;</span> : : : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 重置AXI DMA控制器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset_dma</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;重置AXI DMA控制器...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重置MM2S通道</span></span><br><span class="line">        <span class="built_in">write_reg</span>(MM2S_DMACR, DMACR_RESET);</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">read_reg</span>(MM2S_DMACR) &amp; DMACR_RESET) &#123;</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重置S2MM通道</span></span><br><span class="line">        <span class="built_in">write_reg</span>(S2MM_DMACR, DMACR_RESET);</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">read_reg</span>(S2MM_DMACR) &amp; DMACR_RESET) &#123;</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待DMA停止</span></span><br><span class="line">        <span class="keyword">while</span> (!(<span class="built_in">read_reg</span>(MM2S_DMASR) &amp; DMASR_HALTED) ||</span><br><span class="line">               !(<span class="built_in">read_reg</span>(S2MM_DMASR) &amp; DMASR_HALTED)) &#123;</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;DMA重置完成&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 等待DMA传输完成</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 超时时间(毫秒)</span></span><br><span class="line"><span class="comment">     * @return true=成功, false=超时</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">wait_for_completion</span><span class="params">(<span class="type">int</span> timeout_ms = <span class="number">5000</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono;</span><br><span class="line">        <span class="keyword">auto</span> start_time = steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">duration_cast</span>&lt;milliseconds&gt;(steady_clock::<span class="built_in">now</span>() - start_time).<span class="built_in">count</span>() &lt; timeout_ms) &#123;</span><br><span class="line">            <span class="type">uint32_t</span> mm2s_status = <span class="built_in">read_reg</span>(MM2S_DMASR);</span><br><span class="line">            <span class="type">uint32_t</span> s2mm_status = <span class="built_in">read_reg</span>(S2MM_DMASR);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查错误</span></span><br><span class="line">            <span class="keyword">if</span> ((mm2s_status &amp; DMASR_ERR_IRQ) || (s2mm_status &amp; DMASR_ERR_IRQ)) &#123;</span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;DMA传输错误!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;MM2S状态: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; mm2s_status &lt;&lt; std::endl;</span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;S2MM状态: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; s2mm_status &lt;&lt; std::dec &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查完成</span></span><br><span class="line">            <span class="keyword">if</span> ((mm2s_status &amp; DMASR_IOC_IRQ) &amp;&amp; (s2mm_status &amp; DMASR_IOC_IRQ)) &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;DMA传输完成!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">100</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;DMA传输超时!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 执行DMA回环传输测试</span></span><br><span class="line"><span class="comment">     * @param transfer_size 传输数据大小(字节)</span></span><br><span class="line"><span class="comment">     * @return true=成功, false=失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">loopback_test</span><span class="params">(<span class="type">size_t</span> transfer_size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transfer_size &gt; buffer_size_) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;传输大小超过缓冲区限制!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n=== 开始DMA回环测试 ===&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;传输大小: &quot;</span> &lt;&lt; transfer_size &lt;&lt; <span class="string">&quot; 字节&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取源缓冲区和目标缓冲区指针</span></span><br><span class="line">        <span class="type">uint8_t</span>* src_buffer = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(dma_buffer_);</span><br><span class="line">        <span class="type">uint8_t</span>* dst_buffer = src_buffer + buffer_size_;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化源数据(测试模式)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; transfer_size; ++i) &#123;</span><br><span class="line">            src_buffer[i] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(i &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清空目标buffer</span></span><br><span class="line">        <span class="built_in">memset</span>(dst_buffer, <span class="number">0</span>, transfer_size);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 同步缓存(确保数据一致性)</span></span><br><span class="line">        __sync_synchronize();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动S2MM通道(接收端先启动)</span></span><br><span class="line">        <span class="built_in">write_reg</span>(S2MM_DMACR, DMACR_RS | DMACR_IOC_IRQEN | DMACR_ERR_IRQEN);</span><br><span class="line">        <span class="built_in">write_reg</span>(S2MM_DA, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(dma_phys_ + buffer_size_) &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">        <span class="built_in">write_reg</span>(S2MM_DA_MSB, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;((dma_phys_ + buffer_size_) &gt;&gt; <span class="number">32</span>));</span><br><span class="line">        <span class="built_in">write_reg</span>(S2MM_LENGTH, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(transfer_size));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 小延时确保S2MM准备就绪</span></span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动MM2S通道(发送端)</span></span><br><span class="line">        <span class="built_in">write_reg</span>(MM2S_DMACR, DMACR_RS | DMACR_IOC_IRQEN | DMACR_ERR_IRQEN);</span><br><span class="line">        <span class="built_in">write_reg</span>(MM2S_SA, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(dma_phys_) &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">        <span class="built_in">write_reg</span>(MM2S_SA_MSB, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(dma_phys_ &gt;&gt; <span class="number">32</span>));</span><br><span class="line">        <span class="built_in">write_reg</span>(MM2S_LENGTH, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(transfer_size));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> start_time = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待传输完成</span></span><br><span class="line">        <span class="type">bool</span> success = <span class="built_in">wait_for_completion</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> end_time = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">        <span class="keyword">auto</span> duration = std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::microseconds&gt;(end_time - start_time);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证数据</span></span><br><span class="line">        <span class="type">bool</span> data_match = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; transfer_size; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (src_buffer[i] != dst_buffer[i]) &#123;</span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;数据不匹配在位置 &quot;</span> &lt;&lt; i</span><br><span class="line">                         &lt;&lt; <span class="string">&quot;: 期望=&quot;</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(src_buffer[i])</span><br><span class="line">                         &lt;&lt; <span class="string">&quot;, 实际=&quot;</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(dst_buffer[i]) &lt;&lt; std::endl;</span><br><span class="line">                data_match = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 性能统计</span></span><br><span class="line">        <span class="type">double</span> throughput_mbps = (transfer_size * <span class="number">8.0</span>) / duration.<span class="built_in">count</span>(); <span class="comment">// Mbps</span></span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;=== 测试结果 ===&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;数据验证: &quot;</span> &lt;&lt; (data_match ? <span class="string">&quot;✓ 通过&quot;</span> : <span class="string">&quot;✗ 失败&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;传输时间: &quot;</span> &lt;&lt; duration.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; μs&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;吞吐量: &quot;</span> &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">2</span>)</span><br><span class="line">                  &lt;&lt; throughput_mbps &lt;&lt; <span class="string">&quot; Mbps&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> success &amp;&amp; data_match;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 显示DMA状态信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print_status</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n=== AXI DMA状态 ===&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="type">uint32_t</span> mm2s_cr = <span class="built_in">read_reg</span>(MM2S_DMACR);</span><br><span class="line">        <span class="type">uint32_t</span> mm2s_sr = <span class="built_in">read_reg</span>(MM2S_DMASR);</span><br><span class="line">        <span class="type">uint32_t</span> s2mm_cr = <span class="built_in">read_reg</span>(S2MM_DMACR);</span><br><span class="line">        <span class="type">uint32_t</span> s2mm_sr = <span class="built_in">read_reg</span>(S2MM_DMASR);</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;MM2S控制寄存器: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; mm2s_cr &lt;&lt; std::dec &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;MM2S状态寄存器: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; mm2s_sr &lt;&lt; std::dec;</span><br><span class="line">        std::cout &lt;&lt; (mm2s_sr &amp; DMASR_IDLE ? <span class="string">&quot; [IDLE]&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">        std::cout &lt;&lt; (mm2s_sr &amp; DMASR_HALTED ? <span class="string">&quot; [HALTED]&quot;</span> : <span class="string">&quot;&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;S2MM控制寄存器: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; s2mm_cr &lt;&lt; std::dec &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;S2MM状态寄存器: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; s2mm_sr &lt;&lt; std::dec;</span><br><span class="line">        std::cout &lt;&lt; (s2mm_sr &amp; DMASR_IDLE ? <span class="string">&quot; [IDLE]&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">        std::cout &lt;&lt; (s2mm_sr &amp; DMASR_HALTED ? <span class="string">&quot; [HALTED]&quot;</span> : <span class="string">&quot;&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 主函数 - DMA回环测试程序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;=== AXI DMA回环测试程序 ===&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;版本: C++17 生产级实现&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;目标: Xilinx Zynq-7020 + Petalinux 2023.2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建DMA控制器实例</span></span><br><span class="line">        <span class="function">AXI_DMA_Controller <span class="title">dma_ctrl</span><span class="params">(<span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span></span>; <span class="comment">// 4MB缓冲区</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示初始状态</span></span><br><span class="line">        dma_ctrl.<span class="built_in">print_status</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行多种大小的测试(限制最大传输大小)</span></span><br><span class="line">        std::vector&lt;<span class="type">size_t</span>&gt; test_sizes = &#123;</span><br><span class="line">            <span class="number">1024</span>,        <span class="comment">// 1KB - 小于FIFO深度</span></span><br><span class="line">            <span class="number">4096</span>,        <span class="comment">// 4KB - 等于FIFO深度</span></span><br><span class="line">            <span class="number">16384</span>,       <span class="comment">// 16KB - 大于FIFO深度</span></span><br><span class="line">            <span class="number">65536</span>,       <span class="comment">// 64KB - 中等传输</span></span><br><span class="line">            <span class="number">256</span> * <span class="number">1024</span>   <span class="comment">// 256KB - 较大数据传输(避免1MB崩溃)</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">bool</span> all_passed = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> size : test_sizes) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;\n&quot;</span> &lt;&lt; std::<span class="built_in">string</span>(<span class="number">50</span>, <span class="string">&#x27;=&#x27;</span>) &lt;&lt; std::endl;</span><br><span class="line">            <span class="type">bool</span> result = dma_ctrl.<span class="built_in">loopback_test</span>(size);</span><br><span class="line">            all_passed &amp;= result;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;测试失败，停止后续测试&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n&quot;</span> &lt;&lt; std::<span class="built_in">string</span>(<span class="number">50</span>, <span class="string">&#x27;=&#x27;</span>) &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;=== 最终测试结果 ===&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; (all_passed ? <span class="string">&quot;✓ 所有测试通过!&quot;</span> : <span class="string">&quot;✗ 存在测试失败&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示最终状态</span></span><br><span class="line">        dma_ctrl.<span class="built_in">print_status</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> all_passed ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;错误: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="代码详细解析"><a href="#代码详细解析" class="headerlink" title="代码详细解析"></a>代码详细解析</h2><h3 id="代码架构概览"><a href="#代码架构概览" class="headerlink" title="代码架构概览"></a>代码架构概览</h3><h4 id="整体设计思路"><a href="#整体设计思路" class="headerlink" title="整体设计思路"></a>整体设计思路</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AXI_DMA_Controller</span> &#123;</span><br><span class="line">    <span class="comment">// 硬件资源管理</span></span><br><span class="line">    <span class="comment">// 寄存器操作封装  </span></span><br><span class="line">    <span class="comment">// DMA传输控制</span></span><br><span class="line">    <span class="comment">// 状态监控和错误处理</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个类采用了<strong>RAII (Resource Acquisition Is Initialization)</strong> 设计模式，确保资源的自动管理和异常安全。</p>
<hr>
<h3 id="类成员变量解析"><a href="#类成员变量解析" class="headerlink" title="类成员变量解析"></a>类成员变量解析</h3><h4 id="硬件资源抽象"><a href="#硬件资源抽象" class="headerlink" title="硬件资源抽象"></a>硬件资源抽象</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> uio_fd_;           <span class="comment">// UIO设备文件描述符</span></span><br><span class="line">    <span class="type">void</span>* reg_base_;       <span class="comment">// 寄存器映射基地址</span></span><br><span class="line">    <span class="type">int</span> cma_fd_;           <span class="comment">// CMA设备文件描述符(/dev/mem)</span></span><br><span class="line">    <span class="type">void</span>* dma_buffer_;     <span class="comment">// DMA缓冲区虚拟地址</span></span><br><span class="line">    <span class="type">uint64_t</span> dma_phys_;    <span class="comment">// DMA缓冲区物理地址</span></span><br><span class="line">    <span class="type">size_t</span> buffer_size_;   <span class="comment">// 缓冲区大小</span></span><br></pre></td></tr></table></figure>

<p><strong>设计解析</strong>:</p>
<ul>
<li><code>uio_fd_</code>: 连接到 <code>/dev/uio3</code>，提供对AXI DMA寄存器的访问权限</li>
<li><code>reg_base_</code>: 通过<code>mmap()</code>将物理寄存器地址映射到用户空间的虚拟地址</li>
<li><code>cma_fd_</code>: 访问<code>/dev/mem</code>以分配连续物理内存</li>
<li><code>dma_buffer_</code>: 用户空间可访问的DMA缓冲区虚拟地址</li>
<li><code>dma_phys_</code>: DMA控制器使用的物理地址(硬件直接访问)</li>
</ul>
<h4 id="为什么需要物理地址"><a href="#为什么需要物理地址" class="headerlink" title="为什么需要物理地址"></a>为什么需要物理地址</h4><p>DMA控制器是硬件设备，它<strong>绕过CPU和MMU</strong>直接访问内存，因此:</p>
<ul>
<li>用户程序使用<strong>虚拟地址</strong>访问数据</li>
<li>DMA硬件使用<strong>物理地址</strong>访问同一块内存</li>
<li>两个地址指向同一物理内存区域，但表示方法不同</li>
</ul>
<hr>
<h3 id="寄存器定义和硬件映射"><a href="#寄存器定义和硬件映射" class="headerlink" title="寄存器定义和硬件映射"></a>寄存器定义和硬件映射</h3><h4 id="AXI-DMA寄存器布局"><a href="#AXI-DMA寄存器布局" class="headerlink" title="AXI DMA寄存器布局"></a>AXI DMA寄存器布局</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MM2S通道寄存器 (内存到流)</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_DMACR = <span class="number">0x00</span>;      <span class="comment">// 控制寄存器</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_DMASR = <span class="number">0x04</span>;      <span class="comment">// 状态寄存器</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_SA = <span class="number">0x18</span>;         <span class="comment">// 源地址寄存器</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_SA_MSB = <span class="number">0x1C</span>;     <span class="comment">// 源地址高32位</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> MM2S_LENGTH = <span class="number">0x28</span>;     <span class="comment">// 传输长度寄存器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// S2MM通道寄存器 (流到内存)  </span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_DMACR = <span class="number">0x30</span>;      <span class="comment">// 控制寄存器</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_DMASR = <span class="number">0x34</span>;      <span class="comment">// 状态寄存器</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_DA = <span class="number">0x48</span>;         <span class="comment">// 目标地址寄存器</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_DA_MSB = <span class="number">0x4C</span>;     <span class="comment">// 目标地址高32位</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> S2MM_LENGTH = <span class="number">0x58</span>;     <span class="comment">// 传输长度寄存器</span></span><br></pre></td></tr></table></figure>

<h4 id="控制位定义解析"><a href="#控制位定义解析" class="headerlink" title="控制位定义解析"></a>控制位定义解析</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制寄存器位定义</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMACR_RS = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>);        <span class="comment">// Run/Stop位</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMACR_RESET = (<span class="number">1</span> &lt;&lt; <span class="number">2</span>);     <span class="comment">// 复位位</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMACR_IOC_IRQEN = (<span class="number">1</span> &lt;&lt; <span class="number">12</span>); <span class="comment">// 完成中断使能</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMACR_ERR_IRQEN = (<span class="number">1</span> &lt;&lt; <span class="number">14</span>); <span class="comment">// 错误中断使能</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态寄存器位定义</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMASR_HALTED = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>);    <span class="comment">// DMA停止状态</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMASR_IDLE = (<span class="number">1</span> &lt;&lt; <span class="number">1</span>);      <span class="comment">// DMA空闲状态</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMASR_IOC_IRQ = (<span class="number">1</span> &lt;&lt; <span class="number">12</span>);  <span class="comment">// 传输完成中断标志</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint32_t</span> DMASR_ERR_IRQ = (<span class="number">1</span> &lt;&lt; <span class="number">14</span>);  <span class="comment">// 错误中断标志</span></span><br></pre></td></tr></table></figure>

<p><strong>位操作原理</strong>:</p>
<ul>
<li><code>(1 &lt;&lt; n)</code>: 创建第n位为1的掩码</li>
<li>用于设置、清除和检查特定的控制位</li>
<li>硬件通过这些位与软件通信状态和控制信息</li>
</ul>
<hr>
<h3 id="构造函数详细解析"><a href="#构造函数详细解析" class="headerlink" title="构造函数详细解析"></a>构造函数详细解析</h3><h4 id="初始化序列"><a href="#初始化序列" class="headerlink" title="初始化序列"></a>初始化序列</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">AXI_DMA_Controller</span><span class="params">(<span class="type">size_t</span> buffer_size = <span class="number">1024</span> * <span class="number">1024</span>)</span> </span></span><br><span class="line"><span class="function">    : uio_fd_(<span class="number">-1</span>), reg_base_(MAP_FAILED), cma_fd_(<span class="number">-1</span>), </span></span><br><span class="line"><span class="function">      dma_buffer_(MAP_FAILED), buffer_size_(buffer_size) &#123;</span></span><br></pre></td></tr></table></figure>

<p><strong>初始化列表的作用</strong>:</p>
<ul>
<li>将所有指针和文件描述符初始化为无效值</li>
<li><code>MAP_FAILED</code>是<code>mmap()</code>的错误返回值</li>
<li>确保在构造失败时析构函数能正确清理</li>
</ul>
<h4 id="UIO设备打开"><a href="#UIO设备打开" class="headerlink" title="UIO设备打开"></a>UIO设备打开</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uio_fd_ = <span class="built_in">open</span>(<span class="string">&quot;/dev/uio3&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line"><span class="keyword">if</span> (uio_fd_ &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;无法打开UIO设备 /dev/uio3&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>标志解析</strong>:</p>
<ul>
<li><code>O_RDWR</code>: 读写模式打开</li>
<li><code>O_SYNC</code>: 同步I&#x2F;O，确保寄存器操作的时序正确性</li>
</ul>
<h4 id="寄存器空间映射"><a href="#寄存器空间映射" class="headerlink" title="寄存器空间映射"></a>寄存器空间映射</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg_base_ = <span class="built_in">mmap</span>(<span class="literal">nullptr</span>, <span class="number">0x10000</span>, PROT_READ | PROT_WRITE, </span><br><span class="line">                MAP_SHARED, uio_fd_, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p><strong>mmap参数解析</strong>:</p>
<ul>
<li><code>nullptr</code>: 让系统选择映射地址</li>
<li><code>0x10000</code>: 64KB地址空间(与硬件设计中的AXI DMA地址空间匹配)</li>
<li><code>PROT_READ | PROT_WRITE</code>: 可读可写权限</li>
<li><code>MAP_SHARED</code>: 共享映射，多个进程可以访问同一物理内存</li>
<li><code>uio_fd_</code>: UIO设备文件描述符</li>
<li><code>0</code>: 从设备的起始地址开始映射</li>
</ul>
<hr>
<h3 id="内存分配策略深度解析"><a href="#内存分配策略深度解析" class="headerlink" title="内存分配策略深度解析"></a>内存分配策略深度解析</h3><h4 id="CMA内存分配原理"><a href="#CMA内存分配原理" class="headerlink" title="CMA内存分配原理"></a>CMA内存分配原理</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">allocate_dma_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cma_fd_ = <span class="built_in">open</span>(<span class="string">&quot;/dev/mem&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    </span><br><span class="line">    <span class="type">uint64_t</span> cma_offset = <span class="number">0x38000000</span>; <span class="comment">// CMA区域中间位置</span></span><br><span class="line">    dma_buffer_ = <span class="built_in">mmap</span>(<span class="literal">nullptr</span>, total_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                      MAP_SHARED, cma_fd_, cma_offset);</span><br><span class="line">    </span><br><span class="line">    dma_phys_ = cma_offset; <span class="comment">// 物理地址直接等于CMA偏移</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>cma_fd_ 是整个物理内存的访问权限证</strong><ul>
<li><code>/dev/mem</code> 就像是一个巨大图书馆的总入口</li>
<li><code>cma_fd_</code> 就是您的借书证，允许您进入这个图书馆</li>
<li>有了借书证，您就可以访问图书馆里的任何书架(任何物理地址)</li>
</ul>
</li>
<li>mmap 的映射过程<ul>
<li><strong>“我要借特定位置的书”</strong>:指定物理地址 0x38000000</li>
<li><strong>“给我一个书桌编号”</strong>:系统分配虚拟地址给 dma_buffer_</li>
<li><strong>“建立对应关系”</strong>:虚拟地址 dma_buffer_ ↔ 物理地址 0x38000000</li>
</ul>
</li>
</ul>
<h4 id="为什么选择0x38000000？"><a href="#为什么选择0x38000000？" class="headerlink" title="为什么选择0x38000000？"></a>为什么选择0x38000000？</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">系统内存布局分析:</span><br><span class="line">├── CMA区域: 0x30000000 - 0x40000000 (256MB)</span><br><span class="line">├── 选择中间位置: 0x38000000</span><br><span class="line">└── 原因:</span><br><span class="line">    ├── 避免与CMA起始地址冲突</span><br><span class="line">    ├── 为其他CMA分配留出空间</span><br><span class="line">    └── 确保有足够的连续内存空间</span><br></pre></td></tr></table></figure>

<h4 id="内存锁定的重要性"><a href="#内存锁定的重要性" class="headerlink" title="内存锁定的重要性"></a>内存锁定的重要性</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">mlock</span>(dma_buffer_, total_size) != <span class="number">0</span>) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;警告: 无法锁定内存页面&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mlock作用</strong>:</p>
<ul>
<li>防止操作系统将DMA缓冲区交换到磁盘</li>
<li>确保物理地址在DMA传输期间保持不变</li>
<li>提高DMA传输的可靠性和性能</li>
</ul>
<hr>
<h3 id="寄存器操作函数解析"><a href="#寄存器操作函数解析" class="headerlink" title="寄存器操作函数解析"></a>寄存器操作函数解析</h3><h4 id="读寄存器函数"><a href="#读寄存器函数" class="headerlink" title="读寄存器函数"></a>读寄存器函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">read_reg</span><span class="params">(<span class="type">uint32_t</span> offset)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">uint32_t</span>* reg_ptr = <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">volatile</span> <span class="type">uint32_t</span>*&gt;(</span><br><span class="line">        <span class="built_in">static_cast</span>&lt;<span class="type">char</span>*&gt;(reg_base_) + offset);</span><br><span class="line">    <span class="keyword">return</span> *reg_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="写寄存器函数"><a href="#写寄存器函数" class="headerlink" title="写寄存器函数"></a>写寄存器函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">write_reg</span><span class="params">(<span class="type">uint32_t</span> offset, <span class="type">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">uint32_t</span>* reg_ptr = <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">volatile</span> <span class="type">uint32_t</span>*&gt;(</span><br><span class="line">        <span class="built_in">static_cast</span>&lt;<span class="type">char</span>*&gt;(reg_base_) + offset);</span><br><span class="line">    *reg_ptr = value;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 确保写入完成</span></span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;dsb sy&quot;</span> : : : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关键技术细节"><a href="#关键技术细节" class="headerlink" title="关键技术细节"></a>关键技术细节</h4><p><strong>volatile关键字的作用</strong></p>
<ul>
<li><strong>防止编译器优化</strong>: 告诉编译器这个内存位置可能被硬件修改</li>
<li><strong>强制每次访问</strong>: 确保每次读写都直接访问硬件寄存器</li>
<li><strong>避免缓存问题</strong>: 防止CPU缓存导致的数据不一致</li>
</ul>
<p><strong>reinterpret_cast的必要性</strong></p>
<ul>
<li><code>reg_base_</code>是<code>void*</code>类型，需要转换为具体的指针类型</li>
<li><code>static_cast&lt;char*&gt;</code> + <code>offset</code>:字节级地址计算</li>
<li><code>reinterpret_cast&lt;volatile uint32_t*&gt;</code>:转换为32位寄存器指针</li>
</ul>
<p><strong>内存屏障指令</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;dsb sy&quot;</span> : : : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>dsb (Data Synchronization Barrier)</strong>: ARM架构的内存屏障指令</p>
<ul>
<li>内存屏障是一种<strong>强制内存操作按特定顺序执行</strong>的机制。它解决的是现代计算机系统中一个很微妙但很重要的问题:<strong>内存操作的顺序可能不是您期望的那样</strong>,防止计算机优化,导致命令的执行先后顺序不一样</li>
</ul>
</li>
<li><p><strong>sy (System)</strong>: 影响整个系统的内存访问顺序</p>
</li>
<li><p><strong>“memory”</strong>: 告诉编译器内存内容可能已改变</p>
</li>
</ul>
<hr>
<h3 id="DMA复位流程解析"><a href="#DMA复位流程解析" class="headerlink" title="DMA复位流程解析"></a>DMA复位流程解析</h3><h4 id="复位序列"><a href="#复位序列" class="headerlink" title="复位序列"></a>复位序列</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">reset_dma</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 触发MM2S通道复位</span></span><br><span class="line">    <span class="built_in">write_reg</span>(MM2S_DMACR, DMACR_RESET);</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">read_reg</span>(MM2S_DMACR) &amp; DMACR_RESET) &#123;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 触发S2MM通道复位</span></span><br><span class="line">    <span class="built_in">write_reg</span>(S2MM_DMACR, DMACR_RESET);</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">read_reg</span>(S2MM_DMACR) &amp; DMACR_RESET) &#123;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 等待DMA完全停止</span></span><br><span class="line">    <span class="keyword">while</span> (!(<span class="built_in">read_reg</span>(MM2S_DMASR) &amp; DMASR_HALTED) || </span><br><span class="line">           !(<span class="built_in">read_reg</span>(S2MM_DMASR) &amp; DMASR_HALTED)) &#123;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="复位流程解析"><a href="#复位流程解析" class="headerlink" title="复位流程解析"></a>复位流程解析</h4><ol>
<li><strong>软件复位</strong>: 设置RESET位触发硬件复位</li>
<li><strong>等待复位完成</strong>: 硬件会自动清除RESET位</li>
<li><strong>确认停止状态</strong>: 检查HALTED位确保DMA完全停止</li>
<li><strong>避免忙等待</strong>: 使用<code>sleep_for</code>减少CPU占用</li>
</ol>
<hr>
<h3 id="DMA传输核心逻辑"><a href="#DMA传输核心逻辑" class="headerlink" title="DMA传输核心逻辑"></a>DMA传输核心逻辑</h3><h4 id="传输启动序列"><a href="#传输启动序列" class="headerlink" title="传输启动序列"></a>传输启动序列</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">loopback_test</span><span class="params">(<span class="type">size_t</span> transfer_size)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 数据准备</span></span><br><span class="line">    <span class="type">uint8_t</span>* src_buffer = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(dma_buffer_);</span><br><span class="line">    <span class="type">uint8_t</span>* dst_buffer = src_buffer + buffer_size_;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化测试数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; transfer_size; ++i) &#123;</span><br><span class="line">        src_buffer[i] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(i &amp; <span class="number">0xFF</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清空目标缓冲区</span></span><br><span class="line">    <span class="built_in">memset</span>(dst_buffer, <span class="number">0</span>, transfer_size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 启动S2MM (接收端)</span></span><br><span class="line">    <span class="built_in">write_reg</span>(S2MM_DMACR, DMACR_RS | DMACR_IOC_IRQEN | DMACR_ERR_IRQEN);</span><br><span class="line">    <span class="built_in">write_reg</span>(S2MM_DA, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(dma_phys_ + buffer_size_) &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">    <span class="built_in">write_reg</span>(S2MM_DA_MSB, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;((dma_phys_ + buffer_size_) &gt;&gt; <span class="number">32</span>));</span><br><span class="line">    <span class="built_in">write_reg</span>(S2MM_LENGTH, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(transfer_size));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 关键延时</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">100</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 启动MM2S (发送端)</span></span><br><span class="line">    <span class="built_in">write_reg</span>(MM2S_DMACR, DMACR_RS | DMACR_IOC_IRQEN | DMACR_ERR_IRQEN);</span><br><span class="line">    <span class="built_in">write_reg</span>(MM2S_SA, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(dma_phys_) &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">    <span class="built_in">write_reg</span>(MM2S_SA_MSB, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(dma_phys_ &gt;&gt; <span class="number">32</span>));</span><br><span class="line">    <span class="built_in">write_reg</span>(MM2S_LENGTH, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(transfer_size));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关键设计决策解析"><a href="#关键设计决策解析" class="headerlink" title="关键设计决策解析"></a>关键设计决策解析</h4><ol>
<li>缓冲区布局</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DMA缓冲区内存布局:</span><br><span class="line">├── 源缓冲区: dma_buffer_ [0 ~ buffer_size_-1]</span><br><span class="line">└── 目标缓冲区: dma_buffer_ + buffer_size_ [buffer_size_ ~ 2*buffer_size_-1]</span><br><span class="line"></span><br><span class="line">物理地址对应:</span><br><span class="line">├── 源物理地址: dma_phys_</span><br><span class="line">└── 目标物理地址: dma_phys_ + buffer_size_</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试数据模式</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src_buffer[i] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(i &amp; <span class="number">0xFF</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>生成0-255循环的测试模式</li>
<li>便于验证数据完整性</li>
<li><code>&amp; 0xFF</code>确保值在0-255范围内</li>
</ul>
<ol start="3">
<li>S2MM先启动的原因</li>
</ol>
<p>在AXI4-Stream协议中:</p>
<ul>
<li><strong>发送方</strong>: 必须等待接收方准备好</li>
<li><strong>接收方</strong>: 需要先设置好接收缓冲区</li>
<li><strong>FIFO缓冲</strong>: 提供临时存储，但容量有限</li>
<li><strong>背压机制</strong>: 如果S2MM未准备好，MM2S会暂停</li>
</ul>
<ol start="4">
<li>64位地址处理</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分别设置高32位和低32位</span></span><br><span class="line"><span class="built_in">write_reg</span>(S2MM_DA, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(addr) &amp; <span class="number">0xFFFFFFFF</span>);      <span class="comment">// 低32位</span></span><br><span class="line"><span class="built_in">write_reg</span>(S2MM_DA_MSB, <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(addr &gt;&gt; <span class="number">32</span>));         <span class="comment">// 高32位</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Zynq-7020支持64位地址空间</li>
<li>需要分别配置高低32位寄存器</li>
<li><code>&amp; 0xFFFFFFFF</code>确保只取低32位</li>
</ul>
<hr>
<h3 id="状态监控和错误处理"><a href="#状态监控和错误处理" class="headerlink" title="状态监控和错误处理"></a>状态监控和错误处理</h3><h4 id="完成检测逻辑"><a href="#完成检测逻辑" class="headerlink" title="完成检测逻辑"></a>完成检测逻辑</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">wait_for_completion</span><span class="params">(<span class="type">int</span> timeout_ms = <span class="number">5000</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono;</span><br><span class="line">    <span class="keyword">auto</span> start_time = steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">duration_cast</span>&lt;milliseconds&gt;(steady_clock::<span class="built_in">now</span>() - start_time).<span class="built_in">count</span>() &lt; timeout_ms) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> mm2s_status = <span class="built_in">read_reg</span>(MM2S_DMASR);</span><br><span class="line">        <span class="type">uint32_t</span> s2mm_status = <span class="built_in">read_reg</span>(S2MM_DMASR);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 错误检测</span></span><br><span class="line">        <span class="keyword">if</span> ((mm2s_status &amp; DMASR_ERR_IRQ) || (s2mm_status &amp; DMASR_ERR_IRQ)) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;DMA传输错误!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 完成检测</span></span><br><span class="line">        <span class="keyword">if</span> ((mm2s_status &amp; DMASR_IOC_IRQ) &amp;&amp; (s2mm_status &amp; DMASR_IOC_IRQ)) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;DMA传输完成!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 超时</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="状态检测策略"><a href="#状态检测策略" class="headerlink" title="状态检测策略"></a>状态检测策略</h4><ol>
<li><strong>双通道检测</strong>: 必须同时检测MM2S和S2MM状态</li>
<li><strong>错误优先</strong>: 先检查错误状态，避免误判</li>
<li><strong>轮询间隔</strong>: 100μs的检测间隔平衡响应性和CPU占用</li>
<li><strong>超时保护</strong>: 5秒超时避免无限等待</li>
</ol>
<h3 id="性能测量"><a href="#性能测量" class="headerlink" title="性能测量"></a>性能测量</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> start_time = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line"><span class="type">bool</span> success = <span class="built_in">wait_for_completion</span>();</span><br><span class="line"><span class="keyword">auto</span> end_time = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line"><span class="keyword">auto</span> duration = std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::microseconds&gt;(end_time - start_time);</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> throughput_mbps = (transfer_size * <span class="number">8.0</span>) / duration.<span class="built_in">count</span>(); <span class="comment">// Mbps</span></span><br></pre></td></tr></table></figure>

<p><strong>性能计算解析</strong>:</p>
<ul>
<li><code>transfer_size * 8.0</code>: 字节转换为位</li>
<li><code>duration.count()</code>: 微秒数</li>
<li>结果单位: Mbps (兆位每秒)</li>
</ul>
<hr>
<h3 id="数据验证机制"><a href="#数据验证机制" class="headerlink" title="数据验证机制"></a>数据验证机制</h3><h4 id="完整性检查"><a href="#完整性检查" class="headerlink" title="完整性检查"></a>完整性检查</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> data_match = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; transfer_size; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (src_buffer[i] != dst_buffer[i]) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;数据不匹配在位置 &quot;</span> &lt;&lt; i </span><br><span class="line">                 &lt;&lt; <span class="string">&quot;: 期望=&quot;</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(src_buffer[i])</span><br><span class="line">                 &lt;&lt; <span class="string">&quot;, 实际=&quot;</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(dst_buffer[i]) &lt;&lt; std::endl;</span><br><span class="line">        data_match = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="验证策略"><a href="#验证策略" class="headerlink" title="验证策略"></a>验证策略</h4><ul>
<li><strong>逐字节比较</strong>: 确保每个字节都正确传输</li>
<li><strong>早期退出</strong>: 发现第一个错误即停止，提高效率</li>
<li><strong>详细错误信息</strong>: 显示具体的错误位置和数据值</li>
</ul>
<hr>
<h3 id="资源管理和RAII"><a href="#资源管理和RAII" class="headerlink" title="资源管理和RAII"></a>资源管理和RAII</h3><h4 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~<span class="built_in">AXI_DMA_Controller</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (dma_buffer_ != MAP_FAILED) &#123;</span><br><span class="line">        <span class="built_in">munlock</span>(dma_buffer_, buffer_size_ * <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">munmap</span>(dma_buffer_, buffer_size_ * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cma_fd_ &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">close</span>(cma_fd_);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (reg_base_ != MAP_FAILED) &#123;</span><br><span class="line">        <span class="built_in">munmap</span>(reg_base_, <span class="number">0x10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (uio_fd_ &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">close</span>(uio_fd_);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="RAII原则体现"><a href="#RAII原则体现" class="headerlink" title="RAII原则体现"></a>RAII原则体现</h4><ol>
<li><strong>获取即初始化</strong>: 构造函数中分配所有资源</li>
<li><strong>自动清理</strong>: 析构函数自动释放资源</li>
<li><strong>异常安全</strong>: 即使发生异常也能正确清理</li>
<li><strong>状态检查</strong>: 只清理已成功分配的资源</li>
</ol>
<hr>
<h3 id="主函数测试框架"><a href="#主函数测试框架" class="headerlink" title="主函数测试框架"></a>主函数测试框架</h3><h4 id="测试策略设计"><a href="#测试策略设计" class="headerlink" title="测试策略设计"></a>测试策略设计</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">size_t</span>&gt; test_sizes = &#123;</span><br><span class="line">    <span class="number">1024</span>,        <span class="comment">// 1KB - 小于FIFO深度</span></span><br><span class="line">    <span class="number">4096</span>,        <span class="comment">// 4KB - 等于FIFO深度  </span></span><br><span class="line">    <span class="number">16384</span>,       <span class="comment">// 16KB - 大于FIFO深度</span></span><br><span class="line">    <span class="number">65536</span>,       <span class="comment">// 64KB - 中等传输</span></span><br><span class="line">    <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment">// 1MB - 大数据传输</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="渐进式测试的意义"><a href="#渐进式测试的意义" class="headerlink" title="渐进式测试的意义"></a>渐进式测试的意义</h4><ol>
<li><strong>基本功能验证</strong>: 1KB测试基本的DMA传输能力</li>
<li><strong>FIFO边界测试</strong>: 4KB测试FIFO满载情况</li>
<li><strong>流控制验证</strong>: 16KB测试大于FIFO深度的传输</li>
<li><strong>性能评估</strong>: 更大的数据量评估峰值性能</li>
<li><strong>稳定性测试</strong>: 不同大小的数据验证系统稳定性</li>
</ol>
<h4 id="错误处理策略"><a href="#错误处理策略" class="headerlink" title="错误处理策略"></a>错误处理策略</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> all_passed = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> size : test_sizes) &#123;</span><br><span class="line">    <span class="type">bool</span> result = dma_ctrl.<span class="built_in">loopback_test</span>(size);</span><br><span class="line">    all_passed &amp;= result;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;测试失败，停止后续测试&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>快速失败策略</strong>: 一旦发现错误立即停止，避免浪费时间和可能的系统损坏。</p>
<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">size_t</span>&gt; test_sizes = &#123;</span><br><span class="line">    <span class="number">1024</span>,        <span class="comment">// 1KB - 小于FIFO深度 (基本功能验证)</span></span><br><span class="line">    <span class="number">4096</span>,        <span class="comment">// 4KB - 等于FIFO深度 (满载测试)</span></span><br><span class="line">    <span class="number">16384</span>,       <span class="comment">// 16KB - 大于FIFO深度 (流控制验证)</span></span><br><span class="line">    <span class="number">65536</span>,       <span class="comment">// 64KB - 中等数据传输</span></span><br><span class="line">    <span class="number">262144</span>       <span class="comment">// 256KB - 大数据传输</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="性能测试结果"><a href="#性能测试结果" class="headerlink" title="性能测试结果"></a>性能测试结果</h4><h4 id="吞吐量分析"><a href="#吞吐量分析" class="headerlink" title="吞吐量分析"></a>吞吐量分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">测试结果统计:</span><br><span class="line">├── 1KB:   178.09 Mbps  (延迟: 46μs)</span><br><span class="line">├── 4KB:   799.22 Mbps  (延迟: 41μs)  </span><br><span class="line">├── 16KB:  3360.82 Mbps (延迟: 39μs)</span><br><span class="line">├── 64KB:  16912.52 Mbps (延迟: 31μs)</span><br><span class="line">└── 256KB: 63550.06 Mbps (延迟: 33μs) ← 峰值性能</span><br></pre></td></tr></table></figure>

<h4 id="性能特点分析"><a href="#性能特点分析" class="headerlink" title="性能特点分析"></a>性能特点分析</h4><ol>
<li><strong>随数据量增长</strong>: 吞吐量显著提升，符合DMA特性</li>
<li><strong>延迟稳定</strong>: 控制在30-50μs，满足实时要求</li>
<li><strong>FIFO效应</strong>: 4KB(FIFO深度)后性能加速明显</li>
<li><strong>峰值性能</strong>: 63.5Gbps足以支持数十路4K视频处理</li>
</ol>
<h4 id="状态寄存器解读"><a href="#状态寄存器解读" class="headerlink" title="状态寄存器解读"></a>状态寄存器解读</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">最终DMA状态:</span><br><span class="line">├── MM2S: 0x15003 状态: 0x1002 [IDLE] </span><br><span class="line">└── S2MM: 0x15003 状态: 0x1002 [IDLE]</span><br><span class="line"></span><br><span class="line">状态位解析:</span><br><span class="line">├── bit 12 (0x1000): 传输完成中断 ✓</span><br><span class="line">├── bit 1 (0x2): DMA空闲状态 ✓</span><br><span class="line">└── 无错误标志位 ✓</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="关键问题解答"><a href="#关键问题解答" class="headerlink" title="关键问题解答"></a>关键问题解答</h1><h2 id="问题1-设备树中断信息解析"><a href="#问题1-设备树中断信息解析" class="headerlink" title="问题1:设备树中断信息解析"></a>问题1:设备树中断信息解析</h2><p><strong>问题</strong>: 如何从hexdump输出判断哪个设备对应哪个中断？</p>
<p><strong>解决方法</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分别查看各设备中断</span></span><br><span class="line"><span class="built_in">cat</span> /proc/device-tree/amba_pl/dma@40400000/interrupts | hexdump -C</span><br><span class="line"><span class="comment"># 输出:00 00 00 1f 00 00 00 04 00 00 00 20 00 00 00 04</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/device-tree/amba_pl/dma@7e200000/interrupts | hexdump -C  </span><br><span class="line"><span class="comment"># 输出:00 00 00 00 00 00 00 1d 00 00 00 04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析方法:</span></span><br><span class="line"><span class="comment"># 1. 通配符顺序:按地址排序处理</span></span><br><span class="line"><span class="comment"># 2. 数据结构:AXI DMA有2个中断，CDMA有1个中断</span></span><br><span class="line"><span class="comment"># 3. 逻辑验证:0x1d(29)与已知CDMA中断号吻合</span></span><br></pre></td></tr></table></figure>

<h2 id="问题2-UIO方案性能影响评估"><a href="#问题2-UIO方案性能影响评估" class="headerlink" title="问题2:UIO方案性能影响评估"></a>问题2:UIO方案性能影响评估</h2><p><strong>问题</strong>: 视频处理应用的性能损失如何？</p>
<p><strong>分析结果</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">性能影响评估:</span><br><span class="line">├── 1080p@30fps: ~62MB/s → UIO损失&lt;3% ✓</span><br><span class="line">├── 4K@30fps: ~249MB/s → UIO损失5-8% ✓  </span><br><span class="line">├── 多路4K: 实测63.5Gbps峰值性能完全满足需求 ✓</span><br><span class="line">└── 结论:UIO方案完全适用于视频处理应用</span><br></pre></td></tr></table></figure>

<h2 id="问题3-DMA启动顺序重要性"><a href="#问题3-DMA启动顺序重要性" class="headerlink" title="问题3:DMA启动顺序重要性"></a>问题3:DMA启动顺序重要性</h2><p><strong>关键发现</strong>: S2MM必须先于MM2S启动，否则可能数据丢失</p>
<p><strong>正确方法</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 先准备接收端</span></span><br><span class="line"><span class="built_in">write_reg</span>(S2MM_*);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 延时确保就绪  </span></span><br><span class="line">std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 启动发送端</span></span><br><span class="line"><span class="built_in">write_reg</span>(MM2S_*);</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>Zzkuang
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="http://zhangkuang.asia/2025/08/05/Xilinx-Zynq-AXI-DMA%E5%9B%9E%E7%8E%AF%E5%BC%80%E5%8F%91%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/" title="Xilinx Zynq AXI DMA回环开发完整指南">http://zhangkuang.asia/2025/08/05/Xilinx-Zynq-AXI-DMA回环开发完整指南/</a>
  </li>
  <li class="post-copyright-license">
      <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-Hans" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Zynq/" rel="tag"># Zynq</a>
              <a href="/tags/Petalinux/" rel="tag"># Petalinux</a>
              <a href="/tags/Xilinx/" rel="tag"># Xilinx</a>
              <a href="/tags/AXI-DMA/" rel="tag"># AXI-DMA</a>
              <a href="/tags/UIO/" rel="tag"># UIO</a>
              <a href="/tags/CMA/" rel="tag"># CMA</a>
              <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux/" rel="tag"># 嵌入式Linux</a>
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/FPGA/" rel="tag"># FPGA</a>
              <a href="/tags/%E7%A1%AC%E4%BB%B6%E8%BD%AF%E4%BB%B6%E5%8D%8F%E5%90%8C/" rel="tag"># 硬件软件协同</a>
              <a href="/tags/%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86/" rel="tag"># 视频处理</a>
              <a href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/" rel="tag"># 高性能计算</a>
              <a href="/tags/%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" rel="tag"># 开发指南</a>
              <a href="/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" rel="tag"># 最佳实践</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/08/03/Petalinux%E7%8E%AF%E5%A2%83%E4%B8%8BBRAM%E9%80%9A%E8%AE%AF%E6%8C%87%E5%8D%97/" rel="prev" title="Petalinux环境下BRAM通讯指南">
                  <i class="fa fa-angle-left"></i> Petalinux环境下BRAM通讯指南
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/08/07/%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E8%AE%A1/" rel="next" title="嵌入式网络服务器设计">
                  嵌入式网络服务器设计 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Kuang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
